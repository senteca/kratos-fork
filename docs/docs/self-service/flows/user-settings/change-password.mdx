---
id: change-password
title: Change Password
---

:::tip Before you start

Please read the
[Username / Email & Password Credentials Documentation](../../../concepts/credentials/username-email-password.mdx)
and [User Settings Documentation](../user-settings.mdx) first.

:::

import CodeFromRemote from '@theme/CodeFromRemote'

This document summarizes exemplary request payloads for performing "change
password" flows using the user settings flow with the `password` method.

ORY Kratos will prompt the user to re-authenticate before the password is
changed, similar to the
[GitHub sudo mode](https://help.github.com/en/github/authenticating-to-github/sudo-mode).

You can configure how long a session is "privileged" by setting:

```yaml title="path/to/kratos/config.yml"
selfservice:
  flows:
    settings:
      # Sessions older than a minute requires the user to sign in again before
      # the password is changed.
      privileged_session_max_age: 1m
```

## Create A User

Before we start with the examples below, let's create a user using the API Flows. This will yield a session token
which then use to perform the profile update flows:

```shell script
username=foo-user@ory.sh
password=sBdHzGp9hAx2Hf2m

actionUrl=$(curl -s -H "Accept: application/json" \
  'http://127.0.0.1:4433/self-service/registration/api' | jq -r '.methods.password.config.action'))

session=$(curl -s  -X POST -H "Accept: application/json" -H "Content-Type: application/json" \
  --data '{ "traits.email": "'$username'", "password": "'$password'" }' \
  "$actionUrl"

session_token=$(echo $session | jq -r '.session_token')
echo $session_token
```

## Browser Clients

Redirecting the browser to the
[Self-Service Settings Endpoint](../user-settings.mdx#user-settings-process-sequence)
initiates the flow:

```shell script
$ curl -s -D - -X GET -H "Authorization: bearer $session_token" \
  --cookie cookie.txt --cookie-jar cookie.txt \
  http://127.0.0.1:4433/self-service/settings/browser

HTTP/1.1 302 Found
Cache-Control: 0
Content-Type: text/html; charset=utf-8
Location: http://127.0.0.1:4455/settings?flow=c3625ca1-7e15-4e4c-82fb-f25e0d48ad48
Vary: Cookie
Date: Thu, 03 Sep 2020 16:11:51 GMT
Content-Length: 95

<a href="http://127.0.0.1:4455/settings?flow=c3625ca1-7e15-4e4c-82fb-f25e0d48ad48">Found</a>.
```

If the `password` method is enabled, the Settings Flow
Response Payload will include a `password` method

```shell script
$ curl -s -H "Authorization: bearer $session_token" -H "Accept: application/json" \
  'http://127.0.0.1:4433/self-service/settings/flows?id=c3625ca1-7e15-4e4c-82fb-f25e0d48ad48' | jq
{
  "id": "c3625ca1-7e15-4e4c-82fb-f25e0d48ad48",
  "type": "browser",
  "expires_at": "2020-09-03T17:11:51.224863098Z",
  "issued_at": "2020-09-03T16:11:51.224863098Z",
  "request_url": "http://127.0.0.1:4433/self-service/settings/browser",
  "messages": null,
  "methods": {
    "password": {
      "method": "password",
      "config": {
        "action": "http://127.0.0.1:4433/self-service/settings/methods/password?flow=c3625ca1-7e15-4e4c-82fb-f25e0d48ad48",
        "method": "POST",
        "fields": [
          {
            "name": "password",
            "type": "password",
            "required": true
          },
          {
            "name": "csrf_token",
            "type": "hidden",
            "required": true,
            "value": "QtTzqFtO6gs8Hp2A3OowF5rFKDJkd9DlYG9O0ZsGpMpezoSbOlrcAx85XAVQzzoN6/eVt/K/7rnE5FnT2o87aA=="
          }
        ]
      }
    }
  },
  "identity": {
    "id": "8eb553ae-7f1f-469f-b03e-46f60a23421b",
    "schema_id": "default",
    "schema_url": "",
    "traits": {
      "email": "foo-user@ory.sh"
    }
  },
  "state": "show_form"
}
```

which in turn is easily to render by filling out a HTML Form template:

```html
<form method="{{ method }}" action="{{ action }}">
  <!-- repeat this for every field -->
  <input type="{{ field.type }}" name="{{ field.name }} required="{{ field.required }}" value="{{ field.value }}"
  <!-- ... -->

  <input type="submit" value="Create account" />
</form>
```

Once submitted, the password is validated. If validation fails, the reason will
be included:

```shell script
$ curl -s -H "Authorization: bearer $session_token" -H "Accept: application/json" \
  'http://127.0.0.1:4433/self-service/settings/flows?id=c3625ca1-7e15-4e4c-82fb-f25e0d48ad48' | jq

{
  "id": "32b36ff4-74af-4871-8658-a67bf942c5d2",
  "type": "browser",
  "expires_at": "2020-09-03T17:17:35.360340863Z",
  "issued_at": "2020-09-03T16:17:35.360340863Z",
  "request_url": "http://127.0.0.1:4433/self-service/settings/browser",
  "active": "password",
  "messages": null,
  "methods": {
    "password": {
      "method": "password",
      "config": {
        "action": "http://127.0.0.1:4433/self-service/settings/methods/password?flow=32b36ff4-74af-4871-8658-a67bf942c5d2",
        "method": "POST",
        "fields": [
          {
            "name": "password",
            "type": "password",
            "required": true,
            "messages": [
              {
                "id": 4000002,
                "text": "Property password is missing.",
                "type": "error",
                "context": {
                  "property": "password"
                }
              }
            ]
          },
          {
            "name": "csrf_token",
            "type": "hidden",
            "required": true,
            "value": "I1Zeka4hP9VbX5l509GdDmRr8gzcJWLSQsyOpYGPLs/9GYEHhQJinrqVUIul1GMSlua9dOARaixS0g5+qryxcg=="
          }
        ]
      }
    }
  },
  "identity": {
    "id": "8eb553ae-7f1f-469f-b03e-46f60a23421b",
    "schema_id": "default",
    "schema_url": "",
    "traits": {
      "email": "foo-user@ory.sh"
    }
  },
  "state": "show_form"
}

```

A successful flow will be marked with `"state": "success"`:

```shell script
curl -s -H "Authorization: bearer $session_token" -H "Accept: application/json" \
  'http://127.0.0.1:4433/self-service/settings/flows?id=32b36ff4-74af-4871-8658-a67bf942c5d2' | jq
{
  "id": "32b36ff4-74af-4871-8658-a67bf942c5d2",
  "type": "browser",
  "expires_at": "2020-09-03T17:17:35.360340863Z",
  "issued_at": "2020-09-03T16:17:35.360340863Z",
  "request_url": "http://127.0.0.1:4433/self-service/settings/browser",
  "active": "password",
  "messages": null,
  "methods": {
    "password": {
      "method": "password",
      "config": {
        "action": "http://127.0.0.1:4433/self-service/settings/methods/password?flow=32b36ff4-74af-4871-8658-a67bf942c5d2",
        "method": "POST",
        "fields": [
          {
            "name": "password",
            "type": "password",
            "required": true
          },
          {
            "name": "csrf_token",
            "type": "hidden",
            "required": true,
            "value": "I1Zeka4hP9VbX5l509GdDmRr8gzcJWLSQsyOpYGPLs/9GYEHhQJinrqVUIul1GMSlua9dOARaixS0g5+qryxcg=="
          }
        ]
      }
    }
  },
  "identity": {
    "id": "8eb553ae-7f1f-469f-b03e-46f60a23421b",
    "schema_id": "default",
    "schema_url": "",
    "traits": {
      "email": "foo-user@ory.sh"
    }
  },
  "state": "success"
}
```

## API Clients

API clients are applications which do not run in a browser or in a URL (e.g.
`https://my-example.org`). These are typically native apps (e.g. iOS, Android).

:::warning

**Never use API flows to implement Browser applications!**

Using API flows in Single-Page-Apps as well as server-side apps opens up several
potential attack vectors, including including Login and other CSRF attacks.

:::

First, we initialize a settings flow by making an authenticated call to:

curl -s -H "Authorization: bearer $session_token" -H "Accept: application/json" \
  'http://127.0.0.1:4433/self-service/settings/api' | jq

```shell script
$ curl -s -H "Authorization: bearer $session_token" -H "Accept: application/json" \
  'http://127.0.0.1:4433/self-service/settings/api' | jq

{
  "id": "579d3b96-e3c6-48de-9404-cea22c958d0e",
  "type": "api",
  "expires_at": "2020-09-03T17:22:40.726225086Z",
  "issued_at": "2020-09-03T16:22:40.726225086Z",
  "request_url": "http://127.0.0.1:4433/self-service/settings/api",
  "messages": null,
  "methods": {
    "password": {
      "method": "password",
      "config": {
        "action": "http://127.0.0.1:4433/self-service/settings/methods/password?flow=579d3b96-e3c6-48de-9404-cea22c958d0e",
        "method": "POST",
        "fields": [
          {
            "name": "password",
            "type": "password",
            "required": true
          },
          {
            "name": "csrf_token",
            "type": "hidden",
            "required": true,
            "value": "tSUkM6PzxsF1tWU7k2f/Woev0kNrxWkLJg+7qIY7sqMPT6VHyMqLGUBfH0BotFVwdM099g9o/LOBk5TyF0YV1g=="
          }
        ]
      }
    }
  },
  "identity": {
    "id": "8eb553ae-7f1f-469f-b03e-46f60a23421b",
    "schema_id": "default",
    "schema_url": "http://127.0.0.1:4433/schemas/default",
    "traits": {
      "email": "foo-user@ory.sh"
    }
  },
  "state": "show_form"
}
```

As you can see, the flow content is very similar to the one for browser flows.
The only difference is that `type` is now `api` and not `browser`.

This payload then renders that payload as a native form. The implementation
depends on the language, platform, and framework you use.

To submit the form, the client makes a request to the action URL which results
in an error here because the session is too old:

```shell script
$ actionUrl=$(curl -s -H "Accept: application/json"  -H "Authorization: bearer $session_token" \
  'http://127.0.0.1:4433/self-service/settings/api' | jq -r '.methods.password.config.action')

$ curl -s -X POST -H "Authorization: bearer $session_token" -H  "Accept: application/json" -H "Content-Type: application/json" \
    -d '{"password": "123456"}' \
    "$actionUrl" | jq

{
  "error": {
    "code": 403,
    "status": "Forbidden",
    "reason": "The login session is too old and thus not allowed to update these fields. Please re-authenticate.",
    "message": "The requested action was forbidden"
  }
}
```

After successfully re-authenticating using the following requests

```shell script
username=foo-user@ory.sh
password=sBdHzGp9hAx2Hf2m

actionUrl=$(curl -s -H "Accept: application/json" \
  'http://127.0.0.1:4433/self-service/login/api' | jq -r '.methods.password.config.action')

session=$(curl -s  -X POST -H "Accept: application/json" -H "Content-Type: application/json" \
  --data '{ "identifier": "'$username'", "password": "'$password'" }' \
  "$actionUrl")

session_token=$(echo $session | jq -r '.session_token')
echo $session_token
```

the validation still fails because the password does not match the password policy:

```shell script
$ actionUrl=$(curl -s -H "Accept: application/json"  -H "Authorization: bearer $session_token" \
  'http://127.0.0.1:4433/self-service/settings/api' | jq -r '.methods.password.config.action')

$ curl -s -X POST -H "Accept: application/json" -H "Content-Type: application/json" -H "Authorization: bearer $session_token" \
    -d '{"password": "123456"}' \
    "$actionUrl" | jq

{
  "id": "0f949710-95c8-424c-91df-d0324636134d",
  "type": "api",
  "expires_at": "2020-09-03T17:30:18.96625261Z",
  "issued_at": "2020-09-03T16:30:18.96625261Z",
  "request_url": "http://127.0.0.1:4433/self-service/settings/api",
  "active": "password",
  "messages": null,
  "methods": {
    "password": {
      "method": "password",
      "config": {
        "action": "http://127.0.0.1:4433/self-service/settings/methods/password?flow=0f949710-95c8-424c-91df-d0324636134d",
        "method": "POST",
        "fields": [
          {
            "name": "password",
            "type": "password",
            "required": true,
            "messages": [
              {
                "id": 4000005,
                "text": "The password can not be used because the password has been found in at least 23597311 data breaches and must no longer be used..",
                "type": "error",
                "context": {
                  "reason": "the password has been found in at least 23597311 data breaches and must no longer be used."
                }
              }
            ]
          },
          {
            "name": "csrf_token",
            "type": "hidden",
            "required": true,
            "value": "jUo+WxtbcW2liVMvGOlufzVoYe2KJUIwbbpmWWCkd9Bn1V+QpGpzqYQIfLFgCRHmPbWiKcM2qbM3SUS0Ojm4AQ=="
          }
        ]
      }
    }
  },
  "identity": {
    "id": "8eb553ae-7f1f-469f-b03e-46f60a23421b",
    "schema_id": "default",
    "schema_url": "http://127.0.0.1:4433/schemas/default",
    "traits": {
      "email": "foo-user@ory.sh"
    }
  },
  "state": "show_form"
}
```

but if we try with a better password, everything will pass!

```shell script
$ password=ByS8NWuFSkDgMjbe

$ actionUrl=$(curl -s -H "Accept: application/json"  -H "Authorization: bearer $session_token" \
  'http://127.0.0.1:4433/self-service/settings/api' | jq -r '.methods.password.config.action')

$ curl -s -X POST -H "Accept: application/json" -H "Content-Type: application/json" -H "Authorization: bearer $session_token" \
    -d '{"password": "'$password'"}' \
    "$actionUrl" | jq

{
  "flow": {
    "id": "19a77a65-9aeb-411d-9d8d-463f4f6c2e34",
    "type": "api",
    "expires_at": "2020-09-03T17:32:17.221516362Z",
    "issued_at": "2020-09-03T16:32:17.221516362Z",
    "request_url": "http://127.0.0.1:4433/self-service/settings/api",
    "messages": null,
    "methods": {
      "password": {
        "method": "password",
        "config": {
          "action": "http://127.0.0.1:4433/self-service/settings/methods/password?flow=19a77a65-9aeb-411d-9d8d-463f4f6c2e34",
          "method": "POST",
          "fields": [
            {
              "name": "password",
              "type": "password",
              "required": true
            },
            {
              "name": "csrf_token",
              "type": "hidden",
              "required": true,
              "value": "ORR0YFz74JOEnZtAwuQBP0e5GeqMCRxaA57YPq20AP4tAlMlw2Sl+V69GuHRcaDi6QpylNLtBkNULCtmgibb9A=="
            }
          ]
        }
      }
    },
    "identity": {
      "id": "8eb553ae-7f1f-469f-b03e-46f60a23421b",
      "schema_id": "default",
      "schema_url": "",
      "traits": {
        "email": "foo-user@ory.sh"
      }
    },
    "state": "success"
  },
  "identity": {
    "id": "8eb553ae-7f1f-469f-b03e-46f60a23421b",
    "schema_id": "default",
    "schema_url": "http://127.0.0.1:4433/schemas/default",
    "traits": {
      "email": "foo-user@ory.sh"
    },
    "verifiable_addresses": [
      {
        "id": "e0fb33b0-8edc-45ac-b84c-92e81b04d982",
        "value": "foo-user@ory.sh",
        "verified": false,
        "via": "email",
        "status": "pending",
        "verified_at": null
      }
    ],
    "recovery_addresses": [
      {
        "id": "6e129b1d-4598-4446-bfa8-106255012185",
        "value": "foo-user@ory.sh",
        "via": "email"
      }
    ]
  }
}
```

## Security and Defenses

Please head over to
[Username / Email and Password Security and Defenses](../user-login-user-registration/username-email-password.mdx#security-and-defenses)
