---
id: openid-connect-social-sign-in-oauth2
title: Social Sign In with OpenID Connect and OAuth2
---

:::tip Before you start

Please read the
[OpenID Connect / OAuth2 Credentials Documentation](../../../concepts/credentials/openid-connect-oidc-oauth2.mdx)
and
[identity Login and Registration Documentation](../identity-login-identity-registration.mdx)
first.

:::

The Social Sign In Method enables you to use

- [GitHub](http://github.com/);
- [Apple](https://developer.apple.com/sign-in-with-apple/);
- [Google](https://developers.google.com/identity/sign-in/web/sign-in);
- [Facebook](https://developers.facebook.com/docs/facebook-login/);
- [ORY Hydra](https://www.ory.sh/hydra);
- [Keycloak](https://www.keycloak.org);
- and every other OpenID Connect Certified Provider

as the Identity Provider. It implements several flows, specifically
[identity Login and identity Registration](../identity-login-identity-registration.mdx)
and [identity Settings](../identity-settings.mdx).

Because OAuth2 and OpenID Connect (OIDC) require the identity to interact with a
browser, this method does not work with API-only flows. You cannot log in or
sign up a identity using this method

- with REST API or AJAX requests only;
- without a browser.

This document summarizes exemplary request payloads for performing "Sign in with
..." flows using the identity login and registration flow with the `oidc`
method.

ORY Kratos automatically converts registration to login flows and vice versa. A
user that's already signed up with his/her Google account will be logged in even
if you initiate a registration request.

:::info

It is very important to add the "session" hook to the after oidc registration
hooks. Otherwise your users need to use the login flow again to be able to get a
session.

```yaml title="path/to/my/kratos/config.yml"
# $ kratos -c path/to/my/kratos/config.yml serve
selfservice:
  flows:
    registration:
      after:
        oidc:
          hooks:
            - hook: session
```

:::

Here we use a configuration with 3 providers:

```yaml title="path/to/my/kratos/config.yml"
selfservice:
  methods:
    oidc:
      enabled: true
      config:
        providers:
          - id: hydra
          # provider, client_id, issuer_url, scope, ...
          - id: google
            # provider, client_id, issuer_url, scope, ...
          - id: github
            # provider, client_id, issuer_url, scope, ...
```

## Browser Clients

### Registration

Redirecting the browser to the
[Self-Service Login and Registration Endpoint](../user-login-user-registration.mdx#user-login-and-user-registration-process-sequence)
initiates the flow:

```shell script
$ curl -s -D - -X GET --cookie cookie.txt --cookie-jar cookie.txt \
        http://127.0.0.1:4433/self-service/registration/browser

HTTP/1.1 302 Found
Cache-Control: 0
Content-Type: text/html; charset=utf-8
Location: http://127.0.0.1:4455/auth/registration?flow=7430f336-0be0-47d1-b1fc-5cc6fcc3f228
Set-Cookie: csrf_token=B/3v+RUD5Q7UNzmnp58CR5yhqyAEQL5uNdvmHO3sP/Y=; Path=/; Domain=127.0.0.1; Max-Age=31536000; HttpOnly
Vary: Cookie
Date: Thu, 03 Sep 2020 14:22:44 GMT
Content-Length: 104

<a href="http://127.0.0.1:4455/auth/registration?flow=7430f336-0be0-47d1-b1fc-5cc6fcc3f228">Found</a>.
```

If the `oidc` method is enabled and at least one provider is
configued, the Registration Request Response Payload will include an `oidc`
method. The method contains different providers, based on your OpenID Connect
Provider configuration:

```shell script
$ curl -s 'http://127.0.0.1:4433/self-service/registration/flows?id=7430f336-0be0-47d1-b1fc-5cc6fcc3f228' | jq

{
  "id": "7430f336-0be0-47d1-b1fc-5cc6fcc3f228",
  "type": "browser",
  "expires_at": "2020-09-03T14:32:44.060729362Z",
  "issued_at": "2020-09-03T14:22:44.060729362Z",
  "request_url": "http://127.0.0.1:4433/self-service/registration/browser",
  "messages": null,
  "methods": {
    "oidc": {
      "method": "oidc",
      "config": {
        "action": "http://127.0.0.1:4433/self-service/methods/oidc/auth/7430f336-0be0-47d1-b1fc-5cc6fcc3f228",
        "method": "POST",
        "fields": [
          {
            "name": "csrf_token",
            "type": "hidden",
            "required": true,
            "value": "LJ3o59zXjukFs1004vyn3QrWDrfutW2e0Iaqo/9Ck6srYAceydRr59GEZJNFY6Walnell+r10/DlXUy/Eq6sXQ=="
          },
          {
            "name": "provider",
            "type": "submit",
            "value": "github"
          }
        ]
      }
    }
  }
}
```

The next step depends on your Identity JSON Schema and your JsonNet code. We're
using the following in this example:

```json title="path/to/identity.traits.json.schema"
{
  "$id": "https://schemas.ory.sh/presets/kratos/quickstart/email-password/identity.schema.json",
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Person",
  "type": "object",
  "properties": {
    "traits": {
      "type": "object",
      "properties": {
        "email": {
          "type": "string",
          "format": "email",
          "title": "E-Mail",
          "minLength": 3,
          "ory.sh/kratos": {
            "credentials": {
              "password": {
                "identifier": true
              }
            }
          }
        },
        "website": {
          "type": "string",
          "format": "uri",
          "minLength": 10
        }
      },
      "required": ["email", "website"],
      "additionalProperties": false
    }
  }
}
```

```jsonnet title="path/to/google.jsonnet
local claims = std.extVar('claims');

if std.length(claims.sub) == 0 then
  error 'claim sub not set'
else
  {
    identity: {
      traits: {
        email: claims.sub,
        [if "website" in claims then "website" else null]: claims.website,
      },
    },
  }
```

This implies that the identity has a required attributes `email` and `website`.
When singing in using Google, we take the `sub` and `website` claim are used to
hydrate these fields. If they're missing or invalid (because e.g. not an email,
the user returns to the registration form with additional fields that need to be
filled out. Please note that these claims are just examples, Google doesn't
actually use email addresses in `sub` fields and also does not include the
`website` claim:

```shell script
$ curl -s 'http://127.0.0.1:4433/self-service/registration/flows?id=44c8d084-5623-437e-8fe2-bed2e09c5076' | jq

{
  "id": "44c8d084-5623-437e-8fe2-bed2e09c5076",
  "type": "browser",
  "expires_at": "2020-09-03T14:33:54.521832263Z",
  "issued_at": "2020-09-03T14:23:54.521832263Z",
  "request_url": "http://127.0.0.1:4433/self-service/registration/browser",
  "active": "oidc",
  "messages": null,
  "methods": {
    "oidc": {
      "method": "oidc",
      "config": {
        "action": "http://127.0.0.1:4433/self-service/methods/oidc/auth/44c8d084-5623-437e-8fe2-bed2e09c5076",
        "method": "POST",
        "fields": [
          {
            "name": "csrf_token",
            "type": "hidden",
            "required": true,
            "value": "zvDuQ/2snq+pHXFi2u08tR9s431fmBfdD8i+bjkDzIc8xEVubcza5HoIwgu2gJZpJywXYSwPLMPcLPE+K55crw=="
          },
          {
            "name": "traits.email",
            "type": "text",
            "value": "aeneas@ory.sh"
          },
          {
            "name": "traits.website",
            "type": "",
            "messages": [
              {
                "id": 4000002,
                "text": "Property website is missing.",
                "type": "error",
                "context": {
                  "property": "website"
                }
              }
            ]
          },
          {
            "name": "provider",
            "type": "submit",
            "value": "github"
          }
        ]
      }
    }
  }
}

```

If the form is valid, ORY Kratos will create the user and respond with a HTTP
302 redirect to the configured redirect URL.

Unless the `session` hook is configured, no session cookie will be included in
the `Set-Cookie` HTTP header.

### Login

Redirecting the browser to the
[Self-Service Login and Registration Endpoint](../user-login-user-registration.mdx#user-login-and-user-registration-process-sequence)
initiates the flow:

```shell script
$ curl -s -D - -X GET --cookie cookie.txt --cookie-jar cookie.txt \
        http://127.0.0.1:4433/self-service/login/browser
HTTP/1.1 302 Found
Cache-Control: 0
Content-Type: text/html; charset=utf-8
Location: http://127.0.0.1:4455/auth/login?flow=2e87577f-1209-407c-b523-4727d7bbdbd4
Set-Cookie: csrf_token=HBp3M2EUNggjJ8GFjCUKGnEyvYWWyD5cpIsXAkGJn6I=; Path=/; Domain=127.0.0.1; Max-Age=31536000; HttpOnly
Vary: Cookie
Date: Thu, 03 Sep 2020 14:25:31 GMT
Content-Length: 97

<a href="http://127.0.0.1:4455/auth/login?flow=2e87577f-1209-407c-b523-4727d7bbdbd4">Found</a>.
```


If the `oidc` method is enabled and at least one provider is
configued, the Login Request Response Payload will include an `oidc` method. The
method contains different providers, based on your OpenID Connect Provider
configuration:

```shell script
$ curl -s 'http://127.0.0.1:4433/self-service/login/flows?id=2e87577f-1209-407c-b523-4727d7bbdbd4' | jq

{
  "id": "2e87577f-1209-407c-b523-4727d7bbdbd4",
  "type": "browser",
  "expires_at": "2020-09-03T14:35:31.366554235Z",
  "issued_at": "2020-09-03T14:25:31.366554235Z",
  "request_url": "http://127.0.0.1:4433/self-service/login/browser",
  "messages": null,
  "methods": {
    "oidc": {
      "method": "oidc",
      "config": {
        "action": "http://127.0.0.1:4433/self-service/methods/oidc/auth/2e87577f-1209-407c-b523-4727d7bbdbd4",
        "method": "POST",
        "fields": [
          {
            "name": "csrf_token",
            "type": "hidden",
            "required": true,
            "value": "O0e8KWxx1zZeNEgUOxNFvV8dVMrK63MXoxU102lj9n0nXcsaDWXhPn0TiZG3Nk+nLi/pT1wjTUsHniLRKOpp3w=="
          },
          {
            "name": "provider",
            "type": "submit",
            "value": "github"
          }
        ]
      }
    }
  },
  "forced": false
}
```

The only form validation error that can happen during this flow is that the ID
Token is missing because the user did not authorize the `openid` grant (does not
apply for `provider: github`):

```shell script
$ curl -s 'http://127.0.0.1:4433/self-service/login/flows?id=2e87577f-1209-407c-b523-4727d7bbdbd4' | jq

{
  "id": "2e87577f-1209-407c-b523-4727d7bbdbd4",
  "type": "browser",
  "expires_at": "2020-09-03T14:35:31.366554235Z",
  "issued_at": "2020-09-03T14:25:31.366554235Z",
  "request_url": "http://127.0.0.1:4433/self-service/login/browser",
  "messages": null,
  "methods": {
    "oidc": {
      "method": "oidc",
      "config": {
        "action": "http://127.0.0.1:4433/self-service/methods/oidc/auth/2e87577f-1209-407c-b523-4727d7bbdbd4",
        "method": "POST",
        "messages": [
          {
            "id": 4000000,
            "type": "error",
            "text": "Authentication failed because no id_token was returned. Please accept the \"openid\" permission and try again."
          }
        ],
        "fields": [
          {
            "name": "csrf_token",
            "type": "hidden",
            "required": true,
            "value": "O0e8KWxx1zZeNEgUOxNFvV8dVMrK63MXoxU102lj9n0nXcsaDWXhPn0TiZG3Nk+nLi/pT1wjTUsHniLRKOpp3w=="
          },
          {
            "name": "provider",
            "type": "submit",
            "value": "github"
          }
        ]
      }
    }
  },
  "forced": false
}
```

If the form is valid (the user exists and the password is correct), ORY Kratos
will respond with a HTTP 302 redirect to the configured redirect URL and set a
session cookie using the `Set-Cookie` HTTP Header.

## API Clients

Social Sign In is currently not possible for API Clients. It will be possible in
a future version, which is partially tracked as
[kratos#273](https://github.com/ory/kratos/issues/273)
